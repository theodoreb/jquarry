"use strict";

var fs = require('fs');
var debug = require('debug')('parse');
var esprima = require('esprima');
var glob = require('glob');
var MockBrowser = require('mock-browser').mocks.MockBrowser;
var vm = require('vm');
var _ = require('underscore');

var jqueryDepsOrder = require('../lib/jquery/module-deps-order');

var jqueryModulesApiFile = './dist/jquery-modules-api.json';
var jqueryFolder = './node_modules/jquery/src/';
var globOpts = {
  cwd: jqueryFolder,
  ignore: [
    // Hard dependency, manually handled.
    'core.js',
    'selector*',
    'sizzle/**/*',
    // jQuery build related.
    'intro.js',
    'outro.js',
    'jquery.js',
    // make things crash.
    'var/class2type.js',
    'var/support.js'
  ]
};


var jQueryMethods = [];
var mockWindow = {
  window: MockBrowser.createWindow(),
  document: MockBrowser.createDocument()
};
// Mock up some jQuery stuff to be able to load individual modules.
_.extend(mockWindow, {
  // for core.js
  arr: [],
  class2type: {},
  hasOwn: {}.hasOwnProperty,
  pnum: (/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/).source,
  push: [].push,
  rnotwhite: (/\S+/g),
  strundefined: typeof undefined,
  support: {},
  // for core/ready.js
  setTimeout: function () {}
});

/**
 * Strip all definitions generated by requirejs
 * Convert "var" modules to var declarations
 * "var module" means the module only contains a return
 * statement that should be converted to a var declaration
 * This is indicated by including the file in any "var" folder
 * @param {String} name
 * @param {String} path
 * @param {String} contents The contents to be written (including their AMD wrappers)
 */
function convert(name, path, contents) {
  var rdefineEnd = /\}\);[^}\w]*$/;
  // Convert var modules
  if (/.\/var\//.test(path)) {
    contents = contents
      .replace(/define\([\w\W]*?return/, "var " + (/var\/([\w-]+)/.exec(name)[1]) + " =")
      .replace(rdefineEnd, "");

    // Sizzle treatment
  }
  else if (/^sizzle$/.test(name)) {
    contents = "var Sizzle =\n" + contents
      // Remove EXPOSE lines from Sizzle
      .replace(/\/\/\s*EXPOSE[\w\W]*\/\/\s*EXPOSE/, "return Sizzle;");

  }
  else {

    contents = contents
      .replace(/\s*return\s+[^\}]+(\}\);[^\w\}]*)$/, "$1")
      // Multiple exports
      .replace(/\s*exports\.\w+\s*=\s*\w+;/g, "");

    // Remove define wrappers, closure ends, and empty declarations
    contents = contents
      .replace(/define\([^{]*?{/, "")
      .replace(rdefineEnd, "");

    // Remove anything wrapped with
    // /* ExcludeStart */ /* ExcludeEnd */
    // or a single line directly after a // BuildExclude comment
    contents = contents
      .replace(/\/\*\s*ExcludeStart\s*\*\/[\w\W]*?\/\*\s*ExcludeEnd\s*\*\//ig, "")
      .replace(/\/\/\s*BuildExclude\n\r?[\w\W]*?\n\r?/ig, "");

    // Remove empty definitions
    contents = contents
      .replace(/define\(\[[^\]]*\]\)[\W\n]+$/, "");
  }
  return contents;
}

function runFile(module, file) {
  var scriptString = convert(module, file, String(fs.readFileSync(jqueryFolder + file)));
  try {
    vm.createScript(scriptString, file).runInNewContext(mockWindow, file);
  }
  catch (e) {
    debug(module);
    debug(scriptString);
    throw e;
  }
}

function getMethods(file) {
  var module = file.replace('.js', '');
  var newMethods = [];

  var curjQuery = _.keys(mockWindow.jQuery);
  var curjQueryfn = _.keys(mockWindow.jQuery.fn);
  var curjQueryexpr = _.keys(mockWindow.jQuery.expr.filters);
  runFile(module, file);
  var newjQuery =  _.keys(mockWindow.jQuery);
  var newjQueryfn = _.keys(mockWindow.jQuery.fn);
  var newjQueryexpr = _.keys(mockWindow.jQuery.expr.filters);

  _.difference(newjQuery, curjQuery).forEach(function (method) {
    newMethods.push({module: module, object: 'jQuery', method: method});
  });
  _.difference(newjQueryfn, curjQueryfn).forEach(function (method) {
    newMethods.push({module: module, object: 'jQuery.fn', method: method});
  });
  _.difference(newjQueryexpr, curjQueryexpr).forEach(function (method) {
    newMethods.push({module: module, object: 'jQuery.expr.filters', method: method});
  });

  debug(module + ': ' + _.pluck(newMethods, 'method'));
  jQueryMethods = jQueryMethods.concat(newMethods);
}


function processjQuerySource(er, files) {
  // Check dependencies and load the files in an order that won't mess things up.
  jqueryDepsOrder(files, {folder: jqueryFolder}).forEach(getMethods);

  debug('Writting file with ' + jQueryMethods.length + ' methods.');
  fs.writeFile(jqueryModulesApiFile, JSON.stringify(jQueryMethods, null, 2));
}


// Fill jQuery object with bare minimum things. We won't check usage for those.
runFile('core', 'core.js');
runFile('sizzle', 'sizzle/dist/sizzle.js');
runFile('selector', 'selector-sizzle.js');

glob("**/*.js", globOpts, processjQuerySource);
